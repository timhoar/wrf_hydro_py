

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>wrfhydropy.core.wrfhydroclasses &mdash; wrfhydropy 0.0.3 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> wrfhydropy
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">wrfhydropy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>wrfhydropy.core.wrfhydroclasses</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for wrfhydropy.core.wrfhydroclasses</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>

<span class="kn">from</span> <span class="nn">.utilities</span> <span class="k">import</span> \
    <span class="n">compare_ncfiles</span><span class="p">,</span> \
    <span class="n">open_nwmdataset</span><span class="p">,</span> \
    <span class="n">__make_relative__</span><span class="p">,</span> \
    <span class="n">lock_pickle</span><span class="p">,</span> \
    <span class="n">unlock_pickle</span><span class="p">,</span> \
    <span class="n">get_git_revision_hash</span>

<span class="kn">from</span> <span class="nn">.job_tools</span> <span class="k">import</span> \
    <span class="n">get_user</span><span class="p">,</span> \
    <span class="n">solve_model_start_end_times</span>

<span class="c1">#########################</span>
<span class="c1"># netcdf file object classes</span>


<div class="viewcode-block" id="WrfHydroTs"><a class="viewcode-back" href="../../../source/wrfhydropy.core.html#wrfhydropy.core.wrfhydroclasses.WrfHydroTs">[docs]</a><span class="k">class</span> <span class="nc">WrfHydroTs</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
<div class="viewcode-block" id="WrfHydroTs.open"><a class="viewcode-back" href="../../../source/wrfhydropy.core.html#wrfhydropy.core.wrfhydroclasses.WrfHydroTs.open">[docs]</a>    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunks</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open a WrfHydroTs object</span>
<span class="sd">        Args:</span>
<span class="sd">            self</span>
<span class="sd">            chunks: chunks argument passed on to xarray.DataFrame.chunk() method</span>
<span class="sd">        Returns:</span>
<span class="sd">            An xarray mfdataset object concatenated on dimension &#39;Time&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">open_nwmdataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="WrfHydroStatic"><a class="viewcode-back" href="../../../source/wrfhydropy.core.html#wrfhydropy.core.wrfhydroclasses.WrfHydroStatic">[docs]</a><span class="k">class</span> <span class="nc">WrfHydroStatic</span><span class="p">(</span><span class="n">pathlib</span><span class="o">.</span><span class="n">PosixPath</span><span class="p">):</span>
<div class="viewcode-block" id="WrfHydroStatic.open"><a class="viewcode-back" href="../../../source/wrfhydropy.core.html#wrfhydropy.core.wrfhydroclasses.WrfHydroStatic.open">[docs]</a>    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open a WrfHydroStatic object</span>
<span class="sd">        Args:</span>
<span class="sd">            self</span>
<span class="sd">        Returns:</span>
<span class="sd">            An xarray dataset object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div></div>


<span class="c1">#########################</span>
<span class="c1"># Classes for constructing and running a wrf_hydro setup </span>
<div class="viewcode-block" id="WrfHydroModel"><a class="viewcode-back" href="../../../source/wrfhydropy.core.html#wrfhydropy.core.wrfhydroclasses.WrfHydroModel">[docs]</a><span class="k">class</span> <span class="nc">WrfHydroModel</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class for a WRF-Hydro model, which consitutes the model source code and compiled binary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">source_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">model_config</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Instantiate a WrfHydroModel object.</span>
<span class="sd">        Args:</span>
<span class="sd">            source_dir: Directory containing the source code, e.g.</span>
<span class="sd">               &#39;wrf_hydro_nwm/trunk/NDHMS&#39;.</span>
<span class="sd">            new_compile_dir: Optional, new directory to to hold results</span>
<span class="sd">               of code compilation.</span>
<span class="sd">        Returns:</span>
<span class="sd">            A WrfHydroModel object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Instantiate all attributes and methods</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="sd">&quot;&quot;&quot;pathlib.Path: pathlib.Path object for source code directory.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="sd">&quot;&quot;&quot;str: String indicating model configuration for compile options, must be one of &#39;NWM&#39;, </span>
<span class="sd">        &#39;Gridded&#39;, or &#39;Reach&#39;.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hydro_namelists</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;dict: Master dictionary of all hydro.namelists stored with the source code.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hrldas_namelists</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;dict: Master dictionary of all namelist.hrldas stored with the source code.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compile_options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;dict: Compile-time options. Defaults are loaded from json file stored with source </span>
<span class="sd">        code.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">git_hash</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="sd">&quot;&quot;&quot;str: Source code version from .version file stored with the source code.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compile_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="sd">&quot;&quot;&quot;pathlib.Path: pathlib.Path object pointing to the compile directory.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compile_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="sd">&quot;&quot;&quot;pathlib.Path: pathlib.Path object pointing to the compile directory.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="sd">&quot;&quot;&quot;str: The compiler chosen at compile time.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configure_log</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="sd">&quot;&quot;&quot;CompletedProcess: The subprocess object generated at configure.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compile_log</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="sd">&quot;&quot;&quot;CompletedProcess: The subprocess object generated at compile.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">object_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="sd">&quot;&quot;&quot;str: A unique id to join object to compile directory.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;list: pathlib.Paths to *.TBL files generated at compile-time.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wrf_hydro_exe</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="sd">&quot;&quot;&quot;pathlib.Path: pathlib.Path to wrf_hydro.exe file generated at compile-time.&quot;&quot;&quot;</span>

        <span class="c1"># Set attributes</span>
        <span class="c1">## Setup directory paths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">source_dir</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>

        <span class="c1">## Load master namelists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hydro_namelists</span> <span class="o">=</span> \
            <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;hydro_namelists.json&#39;</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hrldas_namelists</span> <span class="o">=</span> \
            <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;hrldas_namelists.json&#39;</span><span class="p">)))</span>

        <span class="c1">## Get code version</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;.version&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="c1">## Load compile options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span> <span class="o">=</span> <span class="n">model_config</span>
        <span class="n">compile_options</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;compile_options.json&#39;</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compile_options</span> <span class="o">=</span> <span class="n">compile_options</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">model_config</span><span class="p">]</span>

<div class="viewcode-block" id="WrfHydroModel.compile"><a class="viewcode-back" href="../../../source/wrfhydropy.core.html#wrfhydropy.core.wrfhydroclasses.WrfHydroModel.compile">[docs]</a>    <span class="k">def</span> <span class="nf">compile</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">compiler</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">compile_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">compile_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Compiles WRF-Hydro using specified compiler and compile options.</span>
<span class="sd">        Args:</span>
<span class="sd">            compiler: The compiler to use, must be one of &#39;pgi&#39;,&#39;gfort&#39;,</span>
<span class="sd">                &#39;ifort&#39;, or &#39;luna&#39;.</span>
<span class="sd">            compile_dir: A non-existant directory to use for compilation.</span>
<span class="sd">            overwrite: Overwrite compile directory if exists.</span>
<span class="sd">            compile_options: Changes to default compile-time options.</span>
<span class="sd">        Returns:</span>
<span class="sd">            Success of compilation and compile directory used. Sets additional</span>
<span class="sd">            attributes to WrfHydroModel</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># A bunch of ugly logic to check compile directory.</span>
        <span class="k">if</span> <span class="n">compile_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compile_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;Run&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compile_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">compile_dir</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile_dir</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compile_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile_dir</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">overwrite</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compile_dir</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">compile_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compile_dir</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; directory already exists&#39;</span><span class="p">)</span>

        <span class="c1"># Add compiler and compile options as attributes and update if needed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">git_hash</span> <span class="o">=</span> <span class="n">get_git_revision_hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span> <span class="o">=</span> <span class="n">compiler</span>

        <span class="k">if</span> <span class="n">compile_options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compile_options</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">compile_options</span><span class="p">)</span>

        <span class="c1"># Get directroy for setEnvar</span>
        <span class="n">compile_options_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;compile_options.sh&#39;</span><span class="p">)</span>

        <span class="c1"># Write setEnvar file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">compile_options_file</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">option</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile_options</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;export </span><span class="si">{}</span><span class="s2">=</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

        <span class="c1"># Compile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configure_log</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;./configure&#39;</span><span class="p">,</span> <span class="n">compiler</span><span class="p">],</span>
                                            <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                            <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                            <span class="n">cwd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source_dir</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">compile_log</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;./compile_offline_NoahMP.sh&#39;</span><span class="p">,</span>
                                           <span class="nb">str</span><span class="p">(</span><span class="n">compile_options_file</span><span class="o">.</span><span class="n">absolute</span><span class="p">())],</span>
                                          <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                          <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                          <span class="n">cwd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source_dir</span><span class="p">)</span>
        <span class="c1"># Change to back to previous working directory</span>

        <span class="c1"># Add in unique ID file to match this object to prevent assosciating</span>
        <span class="c1"># this directory with another object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">object_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compile_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;.uid&#39;</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">object_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile_log</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Open permissions on compiled files</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;chmod&#39;</span><span class="p">,</span><span class="s1">&#39;-R&#39;</span><span class="p">,</span><span class="s1">&#39;755&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;Run&#39;</span><span class="p">))])</span>

            <span class="c1"># Wrf hydro always puts files in source directory under a new directory called &#39;Run&#39;</span>
            <span class="c1"># Copy files to new directory if its not the same as the source code directory</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compile_dir</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_dir</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;Run&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*.TBL&#39;</span><span class="p">):</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compile_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">)))</span>

                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;Run&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;wrf_hydro.exe&#39;</span><span class="p">)),</span>
                         <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compile_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;wrf_hydro.exe&#39;</span><span class="p">)))</span>

                <span class="c1">#Remove old files</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;Run&#39;</span><span class="p">))</span>

            <span class="c1"># Open permissions on copied compiled files</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;chmod&#39;</span><span class="p">,</span> <span class="s1">&#39;-R&#39;</span><span class="p">,</span> <span class="s1">&#39;755&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compile_dir</span><span class="p">)])</span>

            <span class="c1">#Get file lists as attributes</span>
            <span class="c1"># Get list of table file paths</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compile_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*.TBL&#39;</span><span class="p">))</span>

            <span class="c1"># Get wrf_hydro.exe file path</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wrf_hydro_exe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;wrf_hydro.exe&#39;</span><span class="p">)</span>

            <span class="c1"># Save the object out to the compile directory</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compile_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;WrfHydroModel.pkl&#39;</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model successfully compiled into &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compile_dir</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Model did not successfully compile.&#39;</span><span class="p">)</span></div></div>

<span class="c1"># WRF-Hydro Domain object</span>
<div class="viewcode-block" id="WrfHydroDomain"><a class="viewcode-back" href="../../../source/wrfhydropy.core.html#wrfhydropy.core.wrfhydroclasses.WrfHydroDomain">[docs]</a><span class="k">class</span> <span class="nc">WrfHydroDomain</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class for a WRF-Hydro domain, which consitutes all domain-specific files needed for a</span>
<span class="sd">    setup.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">domain_top_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">domain_config</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">model_version</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">namelist_patch_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;namelist_patches.json&#39;</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Instantiate a WrfHydroDomain object</span>
<span class="sd">        Args:</span>
<span class="sd">            domain_top_dir: Parent directory containing all domain directories and files.</span>
<span class="sd">            domain_config: The domain configuration to use, options are &#39;NWM&#39;,</span>
<span class="sd">                &#39;Gridded&#39;, or &#39;Reach&#39;</span>
<span class="sd">            model_version: The WRF-Hydro model version</span>
<span class="sd">            namelist_patch_file: Filename of json file containing namelist patches</span>
<span class="sd">        Returns:</span>
<span class="sd">            A WrfHydroDomain directory object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">###Instantiate arguments to object</span>
        <span class="c1"># Make file paths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">domain_top_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">domain_top_dir</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;pathlib.Path: pathlib.Paths to *.TBL files generated at compile-time.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">namelist_patch_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain_top_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">namelist_patch_file</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;pathlib.Path: pathlib.Path to the namelist_patches json file.&quot;&quot;&quot;</span>

        <span class="c1"># Load namelist patches</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">namelist_patches</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">namelist_patch_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">))</span>
        <span class="sd">&quot;&quot;&quot;dict: Domain-specific namelist settings.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model_version</span> <span class="o">=</span> <span class="n">model_version</span>
        <span class="sd">&quot;&quot;&quot;str: Specified source-code version for which the domain is to be used.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">domain_config</span> <span class="o">=</span> <span class="n">domain_config</span>
        <span class="sd">&quot;&quot;&quot;str: Specified configuration for which the domain is to be used, e.g. &#39;NWM&#39;&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hydro_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;list: Files specified in hydro_nlist section of the domain namelist patches&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nudging_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;list: Files specified in nudging_nlist section of the domain namelist patches&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lsm_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;list: Files specified in noahlsm_offline section of the domain namelist patches&quot;&quot;&quot;</span>
        <span class="c1">###</span>

        <span class="c1"># Create file paths from hydro namelist</span>
        <span class="n">domain_hydro_nlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">namelist_patches</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model_version</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">domain_config</span><span class="p">][</span>
            <span class="s1">&#39;hydro_namelist&#39;</span><span class="p">][</span><span class="s1">&#39;hydro_nlist&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">domain_hydro_nlist</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain_top_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">file_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">file_path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span><span class="s1">&#39;.nc&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hydro_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">WrfHydroStatic</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hydro_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

        <span class="c1"># Create file paths from nudging namelist</span>
        <span class="n">domain_nudging_nlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">namelist_patches</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model_version</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">domain_config</span>
        <span class="p">][</span><span class="s1">&#39;hydro_namelist&#39;</span><span class="p">][</span><span class="s1">&#39;nudging_nlist&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">domain_nudging_nlist</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain_top_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">file_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">file_path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span><span class="s1">&#39;.nc&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nudging_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">WrfHydroStatic</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nudging_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

        <span class="c1"># Create symlinks from lsm namelist</span>
        <span class="n">domain_lsm_nlist</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">namelist_patches</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model_version</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">domain_config</span><span class="p">][</span><span class="s1">&#39;namelist_hrldas&#39;</span>
            <span class="p">][</span><span class="s2">&quot;noahlsm_offline&quot;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">domain_lsm_nlist</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain_top_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">file_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">file_path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s1">&#39;.nc&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lsm_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">WrfHydroStatic</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lsm_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;indir&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">forcing_dir</span> <span class="o">=</span> <span class="n">file_path</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">forcing_data</span> <span class="o">=</span> <span class="n">WrfHydroTs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forcing_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="WrfHydroSetup"><a class="viewcode-back" href="../../../source/wrfhydropy.core.html#wrfhydropy.core.wrfhydroclasses.WrfHydroSetup">[docs]</a><span class="k">class</span> <span class="nc">WrfHydroSetup</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class for a WRF-Hydro setup object, which is comprised of a WrfHydroModel and a WrfHydroDomain.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">wrf_hydro_model</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
        <span class="n">wrf_hydro_domain</span><span class="p">:</span> <span class="nb">object</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Instantiates a WrfHydroSetup object</span>
<span class="sd">        Args:</span>
<span class="sd">            wrf_hydro_model: A WrfHydroModel object</span>
<span class="sd">            wrf_hydro_domain: A WrfHydroDomain object</span>
<span class="sd">        Returns:</span>
<span class="sd">            A WrfHydroSetup object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Validate that hte domain and model are compatible</span>
        <span class="k">if</span> <span class="n">wrf_hydro_model</span><span class="o">.</span><span class="n">model_config</span> <span class="o">!=</span> <span class="n">wrf_hydro_domain</span><span class="o">.</span><span class="n">domain_config</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Model configuration &#39;</span><span class="o">+</span>
                            <span class="n">wrf_hydro_model</span><span class="o">.</span><span class="n">model_config</span><span class="o">+</span>
                            <span class="s1">&#39; not compatible with domain configuration &#39;</span><span class="o">+</span>
                            <span class="n">wrf_hydro_domain</span><span class="o">.</span><span class="n">domain_config</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">wrf_hydro_model</span><span class="o">.</span><span class="n">version</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">wrf_hydro_domain</span><span class="o">.</span><span class="n">namelist_patches</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Model version &#39;</span><span class="o">+</span>
                            <span class="n">wrf_hydro_model</span><span class="o">.</span><span class="n">versions</span><span class="o">+</span>
                            <span class="s1">&#39; not compatible with domain versions &#39;</span><span class="o">+</span>
                            <span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">wrf_hydro_domain</span><span class="o">.</span><span class="n">namelist_patches</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>

        <span class="c1"># assign objects to self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">wrf_hydro_model</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;WrfHydroModel: A copy of the WrfHydroModel object used for the setup&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">wrf_hydro_domain</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;WrfHydroDomain: A copy of the WrfHydroDomain object used for the setup&quot;&quot;&quot;</span>

        <span class="c1"># Create namelists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hydro_namelist</span> <span class="o">=</span> \
            <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">hydro_namelists</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">version</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">domain_config</span><span class="p">])</span>
        <span class="sd">&quot;&quot;&quot;dict: A copy of the hydro_namelist used by the WrfHydroModel for the specified model </span>
<span class="sd">        version and domain configuration&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">namelist_hrldas</span> <span class="o">=</span> \
            <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">hrldas_namelists</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">version</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">domain_config</span><span class="p">])</span>
        <span class="sd">&quot;&quot;&quot;dict: A copy of the hrldas_namelist used by the WrfHydroModel for the specified model </span>
<span class="sd">        version and domain configuration&quot;&quot;&quot;</span>

        <span class="c1">## Update namelists with namelist patches</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hydro_namelist</span><span class="p">[</span><span class="s1">&#39;hydro_nlist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">namelist_patches</span>
                                                  <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">version</span><span class="p">]</span>
                                                  <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">domain_config</span><span class="p">]</span>
                                                  <span class="p">[</span><span class="s1">&#39;hydro_namelist&#39;</span><span class="p">]</span>
                                                  <span class="p">[</span><span class="s1">&#39;hydro_nlist&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hydro_namelist</span><span class="p">[</span><span class="s1">&#39;nudging_nlist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">namelist_patches</span>
                                                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">version</span><span class="p">]</span>
                                                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">domain_config</span><span class="p">]</span>
                                                    <span class="p">[</span><span class="s1">&#39;hydro_namelist&#39;</span><span class="p">]</span>
                                                    <span class="p">[</span><span class="s1">&#39;nudging_nlist&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">namelist_hrldas</span><span class="p">[</span><span class="s1">&#39;noahlsm_offline&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">namelist_patches</span>
                                                       <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">version</span><span class="p">]</span>
                                                       <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">domain_config</span><span class="p">]</span>
                                                       <span class="p">[</span><span class="s1">&#39;namelist_hrldas&#39;</span><span class="p">]</span>
                                                       <span class="p">[</span><span class="s1">&#39;noahlsm_offline&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">namelist_hrldas</span><span class="p">[</span><span class="s1">&#39;wrf_hydro_offline&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">namelist_patches</span>
                                                         <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">version</span><span class="p">]</span>
                                                         <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">domain_config</span><span class="p">]</span>
                                                         <span class="p">[</span><span class="s1">&#39;namelist_hrldas&#39;</span><span class="p">]</span>
                                                         <span class="p">[</span><span class="s1">&#39;wrf_hydro_offline&#39;</span><span class="p">])</span>

    <span class="c1"># Dont self pickle, there&#39;s no natural location.    </span>
<div class="viewcode-block" id="WrfHydroSetup.pickle"><a class="viewcode-back" href="../../../source/wrfhydropy.core.html#wrfhydropy.core.wrfhydroclasses.WrfHydroSetup.pickle">[docs]</a>    <span class="k">def</span> <span class="nf">pickle</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="nb">dir</span>
    <span class="p">):</span>
        <span class="c1"># create a UID for the run and save in file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">object_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;.uid&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">object_id</span><span class="p">)</span>

        <span class="c1"># Save object to run directory</span>
        <span class="c1"># Save the object out to the compile directory</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;WrfHydroSetup.pkl&#39;</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="WrfHydroRun"><a class="viewcode-back" href="../../../source/wrfhydropy.core.html#wrfhydropy.core.wrfhydroclasses.WrfHydroRun">[docs]</a><span class="k">class</span> <span class="nc">WrfHydroRun</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">wrf_hydro_setup</span><span class="p">:</span> <span class="n">WrfHydroSetup</span><span class="p">,</span>
        <span class="n">run_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">rm_existing_run_dir</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span>
        <span class="n">jobs</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">deepcopy_setup</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>    
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Instantiate a WrfHydroRun object. A run is a WrfHydroSetup with multiple jobs.</span>
<span class="sd">        Args:</span>
<span class="sd">            wrf_hydro_setup: A setup object. </span>
<span class="sd">            run_dir: str, where to execute the job. This is an attribute of the Run object.</span>
<span class="sd">            job: Optional, Job object </span>
<span class="sd">        Returns:</span>
<span class="sd">            A WrfHydroRun object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialize all attributes and methods</span>

        <span class="k">if</span> <span class="n">deepcopy_setup</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">wrf_hydro_setup</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup</span> <span class="o">=</span> <span class="n">wrf_hydro_setup</span>
        <span class="sd">&quot;&quot;&quot;WrfHydroSetup: The WrfHydroSetup object used for the run&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">PosixPath</span><span class="p">(</span><span class="n">run_dir</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;pathlib.PosixPath: The location of where the jobs will be executed.&quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">jobs_completed</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;Job: A list of previously executed jobs for this run.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobs_pending</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;Job: A list of jobs *scheduled* to be executed for this run </span>
<span class="sd">        with prior job dependence.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_active</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="sd">&quot;&quot;&quot;Job: The job currently executing.&quot;&quot;&quot;</span>        

        <span class="c1"># TODO(JLM): these are properties of the run.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel_rt</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;WrfHydroTs: Timeseries dataset of CHRTOUT files&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chanobs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;WrfHydroTs: Timeseries dataset of CHANOBS files&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lakeout</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;WrfHydroTs: Timeseries dataset of LAKEOUT files&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gwout</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;WrfHydroTs: Timeseries dataset of GWOUT files&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restart_hydro</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;list: List of HYDRO_RST WrfHydroStatic objects&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restart_lsm</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;list: List of RESTART WrfHydroStatic objects&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restart_nudging</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;list: List of nudgingLastObs WrfHydroStatic objects&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">object_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="sd">&quot;&quot;&quot;str: A unique id to join object to run directory.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pickle_lock_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="sd">&quot;&quot;&quot;pathlib.PosixPath: The pickle lock file path.&quot;&quot;&quot;</span>
        
        <span class="c1"># Establish the values. </span>
        
        <span class="c1"># TODO(JLM): Check that the setup object is &quot;complete&quot;.</span>
        <span class="c1"># TODO(JLM): What constitutes a complete sim object?</span>
        <span class="c1">#            1) compiler specified, 2) domain_config specified.</span>
        <span class="c1">#            3) A compiled model?</span>

        <span class="c1"># TODO(JLM): If adding a job to an existing run, enforce that only</span>
        <span class="c1">#            start times and khour/kday and associated restart file</span>
        <span class="c1">#            times are different? Anything else that&#39;s flexible across</span>
        <span class="c1">#            jobs of a single run?</span>


        <span class="c1"># Make run_dir directory if it does not exist.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span> <span class="ow">and</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;w&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">rm_existing_run_dir</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Run directory already exists, mode=&#39;w&#39;, &quot;</span> <span class="o">+</span>
                             <span class="s2">&quot;and rm_existing_run_dir is False: clobbering not allowed.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">rm_existing_run_dir</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Check that compile object uid matches compile directory uid</span>
        <span class="c1"># This is to ensure that a new model has not been compiled into that directory unknowingly</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">compile_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;.uid&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">compile_uid</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">object_id</span> <span class="o">!=</span> <span class="n">compile_uid</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">PermissionError</span><span class="p">(</span><span class="s1">&#39;object id mismatch between WrfHydroModel object and&#39;</span>
                                  <span class="s1">&#39;WrfHydroModel.compile_dir directory. Directory may have been&#39;</span>
                                  <span class="s1">&#39;used for another compile&#39;</span><span class="p">)</span>

        <span class="c1"># Build the inputs into the run_dir.</span>
        <span class="c1"># Construct all file/dir paths.</span>
        <span class="c1"># Convert strings to pathlib.Path objects.</span>

        <span class="c1"># TODO(JLM): Make symlinks the default option? Also allow copying?</span>

        <span class="c1"># Loop to make symlinks for each TBL file</span>
        <span class="k">for</span> <span class="n">from_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">table_files</span><span class="p">:</span>
            <span class="c1"># Create file paths to symlink</span>
            <span class="n">to_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">from_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="c1"># Create symlinks</span>
            <span class="n">to_file</span><span class="o">.</span><span class="n">symlink_to</span><span class="p">(</span><span class="n">from_file</span><span class="p">)</span>

        <span class="c1"># Symlink in exe</span>
        <span class="n">wrf_hydro_exe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">wrf_hydro_exe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">wrf_hydro_exe</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">symlink_to</span><span class="p">(</span><span class="n">wrf_hydro_exe</span><span class="p">)</span>

        <span class="c1"># Symlink in forcing</span>
        <span class="n">forcing_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">forcing_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">forcing_dir</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">symlink_to</span><span class="p">(</span><span class="n">forcing_dir</span><span class="p">,</span> <span class="n">target_is_directory</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># create DOMAIN directory and symlink in files</span>
        <span class="c1"># Symlink in hydro_files</span>
        <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">hydro_files</span><span class="p">:</span>
            <span class="c1"># Get new file path for run directory, relative to the top-level domain directory</span>
            <span class="c1"># This is needed to ensure the path matches the domain namelist</span>
            <span class="n">relative_path</span> <span class="o">=</span> <span class="n">file_path</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">domain_top_dir</span><span class="p">)</span>
            <span class="n">symlink_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">relative_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">symlink_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">symlink_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">symlink_path</span><span class="o">.</span><span class="n">symlink_to</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

        <span class="c1"># Symlink in nudging files</span>
        <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">nudging_files</span><span class="p">:</span>
            <span class="c1"># Get new file path for run directory, relative to the top-level domain directory</span>
            <span class="c1"># This is needed to ensure the path matches the domain namelist</span>
            <span class="n">relative_path</span> <span class="o">=</span> <span class="n">file_path</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">domain_top_dir</span><span class="p">)</span>
            <span class="n">symlink_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">relative_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">symlink_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">symlink_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">symlink_path</span><span class="o">.</span><span class="n">symlink_to</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

        <span class="c1"># Symlink in lsm files</span>
        <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">lsm_files</span><span class="p">:</span>
            <span class="c1"># Get new file path for run directory, relative to the top-level domain directory</span>
            <span class="c1"># This is needed to ensure the path matches the domain namelist</span>
            <span class="n">relative_path</span> <span class="o">=</span> <span class="n">file_path</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">domain_top_dir</span><span class="p">)</span>
            <span class="n">symlink_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">relative_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">symlink_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">symlink_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">symlink_path</span><span class="o">.</span><span class="n">symlink_to</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

        <span class="c1"># Restart files are symlinked in to the run dir at run init.</span>
        <span class="n">model_files</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">hydro_files</span><span class="p">,</span>
                       <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">nudging_files</span><span class="p">,</span>
                       <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">lsm_files</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="n">model_files</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;.*/RESTART/.*&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">ff</span><span class="p">)):</span>
                    <span class="n">symlink_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">ff</span><span class="p">))</span>
                    <span class="n">symlink_path</span><span class="o">.</span><span class="n">symlink_to</span><span class="p">(</span><span class="n">ff</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">jobs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_jobs</span><span class="p">(</span><span class="n">jobs</span><span class="p">)</span>


<div class="viewcode-block" id="WrfHydroRun.add_jobs"><a class="viewcode-back" href="../../../source/wrfhydropy.core.html#wrfhydropy.core.wrfhydroclasses.WrfHydroRun.add_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">add_jobs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">jobs</span><span class="p">:</span> <span class="nb">list</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dispatch a run the wrf_hydro setup: either run() or schedule_run()</span>
<span class="sd">        If a scheduler is passed, then that run is scheduled. </span>
<span class="sd">        Args:</span>
<span class="sd">            As for run and schedule_run().</span>
<span class="sd">        Returns:</span>
<span class="sd">            A WrfHydroRun object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Dont tamper with the passed object, let it remain a template in the calling level.</span>
        <span class="n">jobs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">jobs</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">jobs</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">jobs</span> <span class="o">=</span> <span class="p">[</span><span class="n">jobs</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>

            <span class="c1"># Attempt to add the job</span>
            <span class="k">if</span> <span class="n">jj</span><span class="o">.</span><span class="n">scheduler</span><span class="p">:</span>

                <span class="c1"># A scheduled job can be appended to the jobs.pending list if</span>
                <span class="c1"># 1) there are no active or pending jobs</span>
                <span class="c1"># 2) if it is (made) dependent on the last active or pending job.</span>

                <span class="c1"># Get the job id of the last active or pending job.</span>
                <span class="n">last_job_id</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_active</span><span class="p">:</span>
                    <span class="n">last_job_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_active</span><span class="o">.</span><span class="n">sched_job_id</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobs_pending</span><span class="p">):</span>
                    <span class="n">last_job_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs_pending</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">sched_job_id</span>

                <span class="c1"># Check the dependency on a previous job</span>
                <span class="k">if</span> <span class="n">last_job_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">jj</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">afterok</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">jj</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">afterok</span> <span class="o">!=</span> <span class="n">last_job_id</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The job&#39;s dependency/afterok conflicts with reality.&quot;</span><span class="p">)</span>
                    <span class="n">jj</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">afterok</span> <span class="o">=</span> <span class="n">last_job_id</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="k">if</span> <span class="n">jj</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">afterok</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The job&#39;s dependency/afterok conflicts with reality.&quot;</span><span class="p">)</span>

            <span class="c1"># Set submission-time job variables here.</span>
            <span class="n">jj</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">()</span>
            <span class="n">job_submission_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="n">jj</span><span class="o">.</span><span class="n">job_submission_time</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">job_submission_time</span><span class="p">)</span>
            <span class="n">jj</span><span class="o">.</span><span class="n">job_date_id</span> <span class="o">=</span> <span class="s1">&#39;{date:%Y-%m-</span><span class="si">%d</span><span class="s1">-%H-%M-%S-</span><span class="si">%f</span><span class="s1">}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="n">job_submission_time</span><span class="p">)</span>

            <span class="n">jj</span><span class="o">.</span><span class="n">model_start_time</span><span class="p">,</span> <span class="n">jj</span><span class="o">.</span><span class="n">model_end_time</span> <span class="o">=</span> <span class="n">solve_model_start_end_times</span><span class="p">(</span>
                <span class="n">jj</span><span class="o">.</span><span class="n">model_start_time</span><span class="p">,</span>
                <span class="n">jj</span><span class="o">.</span><span class="n">model_end_time</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setup</span>
            <span class="p">)</span>

            <span class="c1"># Add a namelist to each job </span>
            <span class="n">jj</span><span class="o">.</span><span class="n">namelist_hrldas</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">namelist_hrldas</span><span class="p">)</span>
            <span class="n">jj</span><span class="o">.</span><span class="n">hydro_namelist</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">hydro_namelist</span><span class="p">)</span>

            <span class="c1"># Satisfying the model start/end times and restart options</span>
            <span class="n">jj</span><span class="o">.</span><span class="n">apply_model_start_end_job_namelists</span><span class="p">()</span>

            <span class="c1"># Check the the resulting namelists are </span>

            <span class="c1"># in the job object?</span>
            <span class="c1"># Determine a different job_name?</span>
            <span class="c1"># Tag the namelists with the job name and symlink? When is the namelist written?</span>

            <span class="c1"># TODO(JLM): </span>
            <span class="c1"># Edit the namelists with model start/end times and if restarting.</span>
            <span class="c1"># Stash the namelists in the job.</span>
            <span class="c1"># This begs for consistency check across jobs: start previous job = end current job</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">jobs_pending</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jj</span><span class="p">)</span></div>


<div class="viewcode-block" id="WrfHydroRun.run_jobs"><a class="viewcode-back" href="../../../source/wrfhydropy.core.html#wrfhydropy.core.wrfhydroclasses.WrfHydroRun.run_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">run_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># Make sure there are no active jobs?</span>
        <span class="c1"># make sure all jobs are either scheduled or interactive?</span>

        <span class="n">run_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs_pending</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scheduler</span><span class="p">:</span>

            <span class="c1"># submit the jobs_pending.</span>
            <span class="n">lock_pickle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">job_afterok</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">hold</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs_pending</span><span class="p">:</span>

                <span class="n">jj</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">afterok</span> <span class="o">=</span> <span class="n">job_afterok</span>
                <span class="c1"># TODO(JLM): why not make hold an attribute?</span>
                <span class="n">jj</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="p">,</span> <span class="n">hold</span><span class="o">=</span><span class="n">hold</span><span class="p">)</span>
                <span class="n">job_afterok</span> <span class="o">=</span> <span class="n">jj</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">sched_job_id</span>
                <span class="n">hold</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">pickle</span><span class="p">()</span>
            <span class="n">unlock_pickle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jobs_pending</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">destruct</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">run_dir</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobs_pending</span><span class="p">)):</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">job_active</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs_pending</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">job_active</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">collect_output</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">jobs_completed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_active</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">job_active</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pickle</span><span class="p">()</span></div>


<div class="viewcode-block" id="WrfHydroRun.collect_output"><a class="viewcode-back" href="../../../source/wrfhydropy.core.html#wrfhydropy.core.wrfhydroclasses.WrfHydroRun.collect_output">[docs]</a>    <span class="k">def</span> <span class="nf">collect_output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_active</span><span class="o">.</span><span class="n">exit_status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Model run failed.&#39;</span><span class="p">)</span>
            <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model run succeeded.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1">#####################</span>
        <span class="c1"># Grab outputs as WrfHydroXX classes of file paths</span>

        <span class="c1"># Get channel files</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*CHRTOUT*&#39;</span><span class="p">)))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">channel_rt</span> <span class="o">=</span> <span class="n">WrfHydroTs</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*CHRTOUT*&#39;</span><span class="p">)))</span>
            <span class="c1"># Make relative to run dir</span>
            <span class="c1"># for file in self.channel_rt:</span>
            <span class="c1">#     file.relative_to(file.parent)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*CHANOBS*&#39;</span><span class="p">)))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chanobs</span> <span class="o">=</span> <span class="n">WrfHydroTs</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*CHANOBS*&#39;</span><span class="p">)))</span>
            <span class="c1"># Make relative to run dir</span>
            <span class="c1"># for file in self.chanobs:</span>
            <span class="c1">#     file.relative_to(file.parent)</span>

        <span class="c1">#Get Lakeout files</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*LAKEOUT*&#39;</span><span class="p">)))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lakeout</span> <span class="o">=</span> <span class="n">WrfHydroTs</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*LAKEOUT*&#39;</span><span class="p">)))</span>

        <span class="c1">#Get gwout files</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*GWOUT*&#39;</span><span class="p">)))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gwout</span> <span class="o">=</span> <span class="n">WrfHydroTs</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*GWOUT*&#39;</span><span class="p">)))</span>

        <span class="c1"># Get restart files and sort by modified time</span>
        <span class="c1"># Hydro restarts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restart_hydro</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;HYDRO_RST*&#39;</span><span class="p">):</span>
            <span class="n">file</span> <span class="o">=</span> <span class="n">WrfHydroStatic</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restart_hydro</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restart_hydro</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restart_hydro</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restart_hydro</span><span class="p">,</span>
                                        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">file</span><span class="p">:</span> <span class="n">file</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mtime_ns</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restart_hydro</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">### LSM Restarts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restart_lsm</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;RESTART*&#39;</span><span class="p">):</span>
            <span class="n">file</span> <span class="o">=</span> <span class="n">WrfHydroStatic</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restart_lsm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                                
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restart_lsm</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restart_lsm</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restart_lsm</span><span class="p">,</span>
                                      <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">file</span><span class="p">:</span> <span class="n">file</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mtime_ns</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restart_lsm</span> <span class="o">=</span> <span class="kc">None</span>
                                    
        <span class="c1">### Nudging restarts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restart_nudging</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;nudgingLastObs*&#39;</span><span class="p">):</span>
            <span class="n">file</span> <span class="o">=</span> <span class="n">WrfHydroStatic</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restart_nudging</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                                        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restart_nudging</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restart_nudging</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restart_nudging</span><span class="p">,</span>
                                          <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">file</span><span class="p">:</span> <span class="n">file</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mtime_ns</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restart_nudging</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pickle</span><span class="p">()</span>    </div>


<div class="viewcode-block" id="WrfHydroRun.pickle"><a class="viewcode-back" href="../../../source/wrfhydropy.core.html#wrfhydropy.core.wrfhydroclasses.WrfHydroRun.pickle">[docs]</a>    <span class="k">def</span> <span class="nf">pickle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># create a UID for the run and save in file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">object_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;.uid&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">object_id</span><span class="p">)</span>

        <span class="c1"># Save object to run directory</span>
        <span class="c1"># Save the object out to the compile directory</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;WrfHydroRun.pkl&#39;</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="WrfHydroRun.unpickle"><a class="viewcode-back" href="../../../source/wrfhydropy.core.html#wrfhydropy.core.wrfhydroclasses.WrfHydroRun.unpickle">[docs]</a>    <span class="k">def</span> <span class="nf">unpickle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Load run object from run directory after a scheduler job</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;WrfHydroRun.pkl&#39;</span><span class="p">),</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">))</span></div>


<div class="viewcode-block" id="WrfHydroRun.destruct"><a class="viewcode-back" href="../../../source/wrfhydropy.core.html#wrfhydropy.core.wrfhydroclasses.WrfHydroRun.destruct">[docs]</a>    <span class="k">def</span> <span class="nf">destruct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># This gets rid of everything but the methods.</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Jobs have been submitted to  the scheduler: This run object will now self destruct.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="WrfHydroRun.make_relative"><a class="viewcode-back" href="../../../source/wrfhydropy.core.html#wrfhydropy.core.wrfhydroclasses.WrfHydroRun.make_relative">[docs]</a>    <span class="k">def</span> <span class="nf">make_relative</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">basepath</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make all file paths relative to a given directory, useful for opening file</span>
<span class="sd">        attributes in a run object after it has been moved or copied to a new directory or</span>
<span class="sd">        system.</span>
<span class="sd">        Args:</span>
<span class="sd">            basepath: The base path to use for relative paths. Defaults to run directory.</span>
<span class="sd">            This rarely needs to be defined.</span>
<span class="sd">        Returns:</span>
<span class="sd">            self with relative files paths for file-like attributes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">__make_relative__</span><span class="p">(</span><span class="n">run_object</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span><span class="n">basepath</span><span class="o">=</span><span class="n">basepath</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DomainDirectory"><a class="viewcode-back" href="../../../source/wrfhydropy.core.html#wrfhydropy.core.wrfhydroclasses.DomainDirectory">[docs]</a><span class="k">class</span> <span class="nc">DomainDirectory</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An object that represents a WRF-Hydro domain directory. Primarily used as a utility class</span>
<span class="sd">       for WrfHydroDomain&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">domain_top_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">domain_config</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">model_version</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">namelist_patch_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;namelist_patches.json&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a run directory of symlinks using the domain namelist patches</span>
<span class="sd">        Args:</span>
<span class="sd">            domain_top_dir: Parent directory containing all domain directories and files.</span>
<span class="sd">            domain_config: The domain configuration to use, options are &#39;NWM&#39;,</span>
<span class="sd">                &#39;Gridded&#39;, or &#39;Reach&#39;</span>
<span class="sd">            model_version: The WRF-Hydro model version</span>
<span class="sd">            namelist_patch_file: Filename of json file containing namelist patches</span>
<span class="sd">        Returns:</span>
<span class="sd">            A DomainDirectory directory object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">###Instantiate arguments to object</span>
        <span class="c1"># Make file paths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">domain_top_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">domain_top_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">namelist_patch_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain_top_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">namelist_patch_file</span><span class="p">)</span>

        <span class="c1"># Load namelist patches</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">namelist_patches</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">namelist_patch_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model_version</span> <span class="o">=</span> <span class="n">model_version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">domain_config</span> <span class="o">=</span> <span class="n">domain_config</span>
        <span class="c1">###</span>

        <span class="c1"># Create file paths from hydro namelist</span>
        <span class="n">domain_hydro_nlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">namelist_patches</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model_version</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">domain_config</span><span class="p">][</span>
            <span class="s1">&#39;hydro_namelist&#39;</span><span class="p">][</span><span class="s1">&#39;hydro_nlist&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hydro_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">domain_hydro_nlist</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain_top_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">file_path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span><span class="s1">&#39;.nc&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hydro_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">WrfHydroStatic</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hydro_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

        <span class="c1"># Create file paths from nudging namelist</span>
        <span class="n">domain_nudging_nlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">namelist_patches</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model_version</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">domain_config</span>
        <span class="p">][</span><span class="s1">&#39;hydro_namelist&#39;</span><span class="p">][</span><span class="s1">&#39;nudging_nlist&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nudging_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">domain_nudging_nlist</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain_top_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">file_path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span><span class="s1">&#39;.nc&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nudging_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">WrfHydroStatic</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nudging_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

        <span class="c1"># Create symlinks from lsm namelist</span>
        <span class="n">domain_lsm_nlist</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">namelist_patches</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model_version</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">domain_config</span><span class="p">][</span><span class="s1">&#39;namelist_hrldas&#39;</span>
            <span class="p">][</span><span class="s2">&quot;noahlsm_offline&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lsm_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">domain_lsm_nlist</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain_top_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">file_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">file_path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s1">&#39;.nc&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lsm_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">WrfHydroStatic</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lsm_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;indir&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">forcing</span> <span class="o">=</span> <span class="n">file_path</span></div>

<span class="c1">####Classes</span>
<div class="viewcode-block" id="RestartDiffs"><a class="viewcode-back" href="../../../source/wrfhydropy.core.html#wrfhydropy.core.wrfhydroclasses.RestartDiffs">[docs]</a><span class="k">class</span> <span class="nc">RestartDiffs</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">candidate_run</span><span class="p">:</span> <span class="n">WrfHydroRun</span><span class="p">,</span>
                 <span class="n">reference_run</span><span class="p">:</span> <span class="n">WrfHydroRun</span><span class="p">,</span>
                 <span class="n">nccmp_options</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;--data&#39;</span><span class="p">,</span><span class="s1">&#39;--metadata&#39;</span><span class="p">,</span> <span class="s1">&#39;--force&#39;</span><span class="p">,</span> <span class="s1">&#39;--quiet&#39;</span><span class="p">],</span>
                 <span class="n">exclude_vars</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ACMELT&#39;</span><span class="p">,</span><span class="s1">&#39;ACSNOW&#39;</span><span class="p">,</span><span class="s1">&#39;SFCRUNOFF&#39;</span><span class="p">,</span><span class="s1">&#39;UDRUNOFF&#39;</span><span class="p">,</span><span class="s1">&#39;ACCPRCP&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;ACCECAN&#39;</span><span class="p">,</span><span class="s1">&#39;ACCEDIR&#39;</span><span class="p">,</span><span class="s1">&#39;ACCETRAN&#39;</span><span class="p">,</span><span class="s1">&#39;qstrmvolrt&#39;</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Calculate Diffs between restart objects for two WrfHydroRun objects</span>
<span class="sd">        Args:</span>
<span class="sd">            candidate_run: The candidate WrfHydroRun object</span>
<span class="sd">            reference_run: The reference WrfHydroRun object</span>
<span class="sd">            nccmp_options: List of long-form command line options passed to nccmp,</span>
<span class="sd">            see http://nccmp.sourceforge.net/ for options</span>
<span class="sd">            exclude_vars: A list of strings containing variables names to</span>
<span class="sd">            exclude from the comparison</span>
<span class="sd">        Returns:</span>
<span class="sd">            A DomainDirectory directory object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Instantiate all attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diff_counts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;dict: Counts of diffs by restart type&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hydro</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;list: List of pandas dataframes if possible or subprocess objects containing hydro </span>
<span class="sd">        restart file diffs&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lsm</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;list: List of pandas dataframes if possible or subprocess objects containing lsm restart </span>
<span class="sd">        file diffs&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nudging</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;list: List of pandas dataframes if possible or subprocess objects containing nudging </span>
<span class="sd">        restart file diffs&quot;&quot;&quot;</span>


        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidate_run</span><span class="o">.</span><span class="n">restart_hydro</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">reference_run</span><span class="o">.</span><span class="n">restart_hydro</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hydro</span> <span class="o">=</span> <span class="n">compare_ncfiles</span><span class="p">(</span><span class="n">candidate_files</span><span class="o">=</span><span class="n">candidate_run</span><span class="o">.</span><span class="n">restart_hydro</span><span class="p">,</span>
                                         <span class="n">reference_files</span><span class="o">=</span><span class="n">reference_run</span><span class="o">.</span><span class="n">restart_hydro</span><span class="p">,</span>
                                         <span class="n">nccmp_options</span> <span class="o">=</span> <span class="n">nccmp_options</span><span class="p">,</span>
                                         <span class="n">exclude_vars</span> <span class="o">=</span> <span class="n">exclude_vars</span><span class="p">)</span>
            <span class="n">diff_counts</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="o">.</span><span class="fm">__ne__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hydro</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">diff_counts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;hydro&#39;</span><span class="p">:</span><span class="n">diff_counts</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;length of candidate_sim.restart_hydro or reference_sim.restart_hydro &#39;</span>
                          <span class="s1">&#39;is 0&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidate_run</span><span class="o">.</span><span class="n">restart_lsm</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">reference_run</span><span class="o">.</span><span class="n">restart_lsm</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lsm</span> <span class="o">=</span> <span class="n">compare_ncfiles</span><span class="p">(</span><span class="n">candidate_files</span><span class="o">=</span><span class="n">candidate_run</span><span class="o">.</span><span class="n">restart_lsm</span><span class="p">,</span>
                                       <span class="n">reference_files</span><span class="o">=</span><span class="n">reference_run</span><span class="o">.</span><span class="n">restart_lsm</span><span class="p">,</span>
                                       <span class="n">nccmp_options</span> <span class="o">=</span> <span class="n">nccmp_options</span><span class="p">,</span>
                                       <span class="n">exclude_vars</span> <span class="o">=</span> <span class="n">exclude_vars</span><span class="p">)</span>
            <span class="n">diff_counts</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="o">.</span><span class="fm">__ne__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lsm</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">diff_counts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;lsm&#39;</span><span class="p">:</span><span class="n">diff_counts</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;length of candidate_sim.restart_lsm or reference_sim.restart_lsm is 0&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">candidate_run</span><span class="o">.</span><span class="n">restart_nudging</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> \
           <span class="n">reference_run</span><span class="o">.</span><span class="n">restart_nudging</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidate_run</span><span class="o">.</span><span class="n">restart_nudging</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">reference_run</span><span class="o">.</span><span class="n">restart_nudging</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nudging</span> <span class="o">=</span> <span class="n">compare_ncfiles</span><span class="p">(</span>
                    <span class="n">candidate_files</span><span class="o">=</span><span class="n">candidate_run</span><span class="o">.</span><span class="n">restart_nudging</span><span class="p">,</span>
                    <span class="n">reference_files</span><span class="o">=</span><span class="n">reference_run</span><span class="o">.</span><span class="n">restart_nudging</span><span class="p">,</span>
                    <span class="n">nccmp_options</span> <span class="o">=</span> <span class="n">nccmp_options</span><span class="p">,</span>
                    <span class="n">exclude_vars</span> <span class="o">=</span> <span class="n">exclude_vars</span><span class="p">)</span>
                <span class="n">diff_counts</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="o">.</span><span class="fm">__ne__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nudging</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">diff_counts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;nudging&#39;</span><span class="p">:</span><span class="n">diff_counts</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;length of candidate_sim.restart_nudging or &#39;</span>
                              <span class="s1">&#39;reference_sim.restart_nudging is 0&#39;</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Joe Mills.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'0.0.3',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>

  

  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>